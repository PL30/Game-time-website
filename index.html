<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Game Time - Book Your Spot</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="bg-blue-600 text-white p-6">
    <h1 class="text-3xl font-bold">Game Time Helsinki</h1>
    <p class="text-sm mt-2">Book football games. Show up. Play. Simple.</p>
  </header>

  <section class="p-6">
    <h2 class="text-xl font-semibold mb-4">Upcoming Games</h2>

    <!-- Single game card (you can duplicate this pattern later) -->
    <div class="grid gap-4 md:grid-cols-2">
      <div class="bg-white p-4 rounded-xl shadow">
        <h3 id="game-title" class="text-lg font-bold">7v7 @ Töölö | Wed, 6pm</h3>
        <p id="game-venue" class="text-sm mt-1 text-gray-600">Töölön Pallokenttä 1</p>
        <p class="text-sm mt-1">
          Players Registered:
          <span class="font-semibold" id="registered-count">0</span>/<span id="capacity">14</span>
        </p>
        <p class="text-sm mt-1">Status: <span class="font-semibold" id="game-status">Pending</span></p>

        <div class="mt-3 space-y-2">
          <input type="text" id="player-name" placeholder="First Name" class="p-2 border rounded w-full" />
          <input type="text" id="player-identifier" placeholder="Email or Phone" class="p-2 border rounded w-full" />
          <input type="text" id="player-position" placeholder="Position (e.g. Midfielder)" class="p-2 border rounded w-full" />
          <select id="player-experience" class="p-2 border rounded w-full">
            <option value="Beginner">Beginner</option>
            <option value="Intermediate">Intermediate</option>
            <option value="Advanced">Advanced</option>
          </select>
          <button onclick="reserveSpot()" class="bg-blue-600 text-white py-2 w-full rounded">Reserve My Spot</button>
          <button onclick="unreserveSpot()" class="bg-red-500 text-white py-2 w-full rounded">Cancel My Spot</button>
        </div>

        <p id="free-note" class="text-sm text-green-700 mt-3 hidden">
          Free pilot game – no payment required.
        </p>

        <div id="pay-cta" class="mt-4 hidden">
          <a id="pay-btn" href="#" class="inline-block bg-blue-600 text-white px-4 py-2 rounded" target="_blank">
            Pay
          </a>
          <p class="text-xs text-gray-500 mt-1">Payment opens in a new tab.</p>
        </div>

        <div class="mt-4">
          <h4 class="font-semibold mb-2">Registered Players:</h4>
          <ul id="registered-names" class="list-disc list-inside text-sm"></ul>
        </div>

        <div class="mt-4 text-sm">
          <a href="#" onclick="showAdminLogin()" class="text-blue-600 underline">Admin Login</a>
          <div id="admin-controls" style="display:none;" class="mt-2">
            <input type="password" id="admin-password" placeholder="Enter Admin Password" class="p-2 border rounded w-full mb-2" />
            <button onclick="verifyAdmin()" class="bg-gray-700 text-white px-4 py-2 rounded w-full">Submit</button>
            <div id="admin-panel" style="display:none;">
              <h4 class="font-semibold mt-4">Admin Controls</h4>
              <button onclick="resetGame()" class="mt-2 bg-gray-700 text-white px-4 py-2 rounded">Reset Game (clear players)</button>

              <div id="admin-payment-block" class="mt-4">
                <p class="text-sm">Payments enabled: <span id="payments-flag">false</span></p>
                <button onclick="togglePayments()" class="bg-blue-600 text-white px-4 py-2 rounded mt-2">Toggle Payments</button>
              </div>

              <div class="mt-4 text-sm text-gray-600">
                WhatsApp: <a href="https://wa.me/358401234567" class="text-blue-500 underline" target="_blank">Message Us</a>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <section class="p-6 mt-8">
    <h2 class="text-xl font-semibold mb-2">How It Works</h2>
    <ol class="list-decimal list-inside space-y-2 text-sm">
      <li>Choose a game and book your spot</li>
      <li>Once minimum players join (e.g., 12/14), the game is confirmed</li>
      <li>If the game is cancelled, you get an automatic refund</li>
    </ol>
  </section>

  <section class="p-6 mt-8 bg-white">
    <h2 class="text-xl font-semibold mb-2">Join Our Community</h2>
    <p class="text-sm mb-4">Follow us for updates and more games!</p>
    <div class="flex space-x-4">
      <a href="https://www.instagram.com/game_time_footy/" target="_blank" class="text-blue-500 underline">Instagram</a>
      <a href="https://www.facebook.com/profile.php?id=61578184484693" target="_blank" class="text-blue-500 underline">Facebook</a>
      <a href="https://docs.google.com/forms/d/e/1FAIpQLSdkHADEb7-xgjajXy7kbAOLg4uiljm0dQvJ5KOanMmRklu7HA/viewform?usp=sharing&ouid=105156732411270285549" target="_blank" class="text-green-600 underline">Complete Our Survey</a>
    </div>
  </section>

  <footer class="p-6 text-center text-xs text-gray-500">
    &copy; 2025 Game Time Helsinki. Built with no-code tools.
  </footer>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const firebaseConfig = {
        apiKey: "AIzaSyD13SBujROGNZp5zA2St9HlawDF_qUYNCk",
        authDomain: "game-time-715fc.firebaseapp.com",
        projectId: "game-time-715fc",
        storageBucket: "game-time-715fc.firebasestorage.app",
        messagingSenderId: "944892095776",
        appId: "1:944892095776:web:966fc85ebf568336eefb45"
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // ---- CONFIG ----
      const gameId = 'toolo-wed-6pm'; // this card's game
      let appSettings = { paymentsEnabled: false };
      let gameMeta = {
        title: "7v7 @ Töölö | Wed, 6pm",
        venue: "Töölön Pallokenttä 1",
        capacity: 14,
        requiresPayment: false,
        price: 5,
        currency: "EUR",
        paymentLink: ""
      };

      const registeredCount = document.getElementById('registered-count');
      const registeredNames = document.getElementById('registered-names');
      const status = document.getElementById('game-status');
      const capEl = document.getElementById('capacity');
      const titleEl = document.getElementById('game-title');
      const venueEl = document.getElementById('game-venue');
      const payCta = document.getElementById('pay-cta');
      const payBtn = document.getElementById('pay-btn');
      const freeNote = document.getElementById('free-note');

      function updateStatus(count) {
        const min = Math.min(gameMeta.capacity || 14, 14); // default safety
        if (count >= 12) {
          status.textContent = "Game Confirmed!";
        } else {
          status.textContent = `Confirmed if ${12 - count} more register`;
        }
      }

      async function loadSettingsAndGame() {
        // settings/app
        try {
          const sdoc = await db.collection('settings').doc('app').get();
          if (sdoc.exists) appSettings = sdoc.data();
        } catch (e) { console.warn('No settings/app yet, defaulting...', e); }

        // games/{gameId}
        try {
          const gdoc = await db.collection('games').doc(gameId).get();
          if (gdoc.exists) gameMeta = Object.assign(gameMeta, gdoc.data());
        } catch (e) { console.warn('No games doc yet, using defaults', e); }

        // reflect meta
        titleEl.textContent = gameMeta.title || titleEl.textContent;
        venueEl.textContent = gameMeta.venue || venueEl.textContent;
        capEl.textContent = gameMeta.capacity || 14;

        // payment UI
        const showPaid = !!(appSettings.paymentsEnabled && gameMeta.requiresPayment && gameMeta.paymentLink);
        if (showPaid) {
          payCta.classList.remove('hidden');
          payBtn.textContent = `Pay €${gameMeta.price || ''}`;
          payBtn.href = gameMeta.paymentLink;
          freeNote.classList.add('hidden');
        } else {
          payCta.classList.add('hidden');
          freeNote.classList.remove('hidden');
        }
      }

      function subscribePlayersList() {
        db.collection("players")
          .where("gameId", "==", gameId)
          .onSnapshot(snapshot => {
            registeredNames.innerHTML = '';
            let count = 0;
            snapshot.forEach(doc => {
              const data = doc.data();
              const li = document.createElement('li');
              li.textContent = data.name || 'Player';
              registeredNames.appendChild(li);
              count++;
            });
            registeredCount.textContent = count;
            updateStatus(count);
          });
      }

      // --- Actions ---
      window.reserveSpot = async function () {
        const name = document.getElementById('player-name').value.trim();
        const identifier = document.getElementById('player-identifier').value.trim();
        const position = document.getElementById('player-position').value.trim();
        const experience = document.getElementById('player-experience').value;

        if (!name || !identifier) {
          alert("Please enter your name and email/phone.");
          return;
        }

        const capacity = Number(gameMeta.capacity || 14);

        // Check capacity
        const current = await db.collection("players").where("gameId", "==", gameId).get();
        if (current.size >= capacity) {
          alert("Game is full. Join the waitlist!");
          return;
        }

        await db.collection("players").add({ name, identifier, position, experience, gameId });

        // Decide what to show next
        if (appSettings.paymentsEnabled && gameMeta.requiresPayment && gameMeta.paymentLink) {
          alert("Spot held — please complete payment on the next page.");
          window.open(gameMeta.paymentLink, "_blank");
        } else {
          alert("Spot reserved! This pilot game is free — see you on the pitch.");
        }

        // clear inputs (optional)
        document.getElementById('player-name').value = '';
        document.getElementById('player-identifier').value = '';
        document.getElementById('player-position').value = '';
        document.getElementById('player-experience').value = 'Beginner';
      }

      window.unreserveSpot = async function () {
        const identifier = document.getElementById('player-identifier').value.trim();
        if (!identifier) {
          alert("Please enter your email or phone number.");
          return;
        }

        const snap = await db.collection("players")
          .where("identifier", "==", identifier)
          .where("gameId", "==", gameId)
          .get();

        if (snap.empty) {
          alert("No reservation found with that email/phone for this game.");
          return;
        }

        const batch = db.batch();
        snap.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        alert("Your spot has been canceled.");
      }

      window.resetGame = async function () {
        const snap = await db.collection("players").where("gameId", "==", gameId).get();
        const batch = db.batch();
        snap.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        alert("Cleared all reservations for this game.");
      }

      window.showAdminLogin = function () {
        document.getElementById('admin-controls').style.display = 'block';
      }

      window.verifyAdmin = async function () {
        const password = document.getElementById('admin-password').value;
        if (password === 'ColePalmerCWC') {
          document.getElementById('admin-panel').style.display = 'block';
          // read current flag
          const sdoc = await db.collection('settings').doc('app').get();
          const flag = sdoc.exists && sdoc.data().paymentsEnabled ? 'true' : 'false';
          document.getElementById('payments-flag').textContent = flag;
        } else {
          alert('Incorrect password.');
        }
      }

      window.togglePayments = async function () {
        const ref = db.collection('settings').doc('app');
        const sdoc = await ref.get();
        const current = sdoc.exists && sdoc.data().paymentsEnabled ? true : false;
        await ref.set({
          paymentsEnabled: !current,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        document.getElementById('payments-flag').textContent = (!current).toString();
        await loadSettingsAndGame();
        alert(`Payments ${!current ? 'ENABLED' : 'DISABLED'}.`);
      }

      // Boot
      loadSettingsAndGame();
      subscribePlayersList();
    });
  </script>
</body>
</html>
